// [why are you going?]
//
// we're going [to the defense] to support charlie, i think
// pretty much nobody knows anything about the stuff he's doing except he himself


// TODO: They need a simulator app
// TODO: Linear actuator with rack

// TODO: tele-operation from cpp

// 60fps

#include "cs345.cpp"
#include "manifoldc.h"
#include "poe.cpp"
#undef real // ???
#define u32 DO_NOT_USE_u32_USE_uint32_INSTEAD

real32 theta0[] =
    { 0.3002676061743008, 0.29716948408346655, 0.2940764999473807, 0.29098857015749124, 0.2879056124934013, 0.28482754608900485, 0.28175429139969754, 0.27868577017061325, 0.2756219054058531, 0.2725626213386706, 0.26950784340257183, 0.26645749820330333, 0.26341151349169134, 0.26036981813730276, 0.25733234210289746, 0.2542990164196448, 0.2512697731630751, 0.24824454542974306, 0.24522326731457467, 0.24220587388887682, 0.24182263374716761, 0.2414555248974406, 0.24110447259984213, 0.2407694039661431, 0.2404502479105779, 0.24014693510223395, 0.23985939791893085, 0.23958757040252676, 0.23933138821559852, 0.2390907885994339, 0.2388657103332934, 0.23865609369488272, 0.23846188042199512, 0.2382830136752735, 0.23811943800205349, 0.2379710993012415, 0.2378379447891914, 0.2377199229665412, 0.2376169835859726, 0.23752907762085873, 0.24065426287371894, 0.24378267454653524, 0.2469143766039349, 0.2500494338797201, 0.2531879120958005, 0.2563298778816744, 0.25947539879447956, 0.26262454333963603, 0.26577738099209414, 0.26893398221821785, 0.27209441849832017, 0.2752587623498747, 0.2784270873514303, 0.28159946816725034, 0.28477598057270714, 0.2879567014804554, 0.2911417089674164, 0.2943310823026014, 0.2975249019758065, 0.3033709512515653, 0.3110768919646819, 0.31881673112024667, 0.32659188125917527, 0.33440381886805326, 0.34225408873555385, 0.3501443087012943, 0.3580761748408934, 0.3660514671369054, 0.3740720556921414, 0.3821399075498413, 0.39025709419442045, 0.39842579981737497, 0.40664833044562965, 0.4149271240446138, 0.4232647617260529, 0.43166398021147995, 0.44012768572750055, 0.4486589695387987, 0.45726112536085006, 0.25755883256666245, 0.2676488197564354, 0.27779501816817187, 0.28800043724403623, 0.2982682665652002, 0.308601891828591, 0.31900491272605314, 0.32948116300771924, 0.3400347330622099, 0.35066999540798305, 0.36139163356544957, 0.37220467487186254, 0.3831145279149866, 0.3941270254031228, 0.4052484734659556, 0.4164857086032814, 0.4278461637808061, 0.4393379455326093, 0.4509699243940694, 0.4627518415923894, 0.24660797419181724, 0.247016734578973, 0.24743539387898716, 0.24786399605038834, 0.2483025859271133, 0.24875120923820648, 0.2492099126280739, 0.2496787436773129, 0.2501577509241393, 0.2506469838864337, 0.25114649308442594, 0.2516563300640463, 0.25217654742096596, 0.25270719882534953, 0.2532483390473519, 0.2538000239833812, 0.2543623106831632, 0.254935257377632, 0.2555189235076828, 0.2561133697538184, 0.47370187191748747, 0.47449786715879083, 0.4753088379959263, 0.4761349514068259, 0.47697637886156874, 0.47783329648709844, 0.47870588523975843, 0.47959433108610394, 0.48049882519247966, 0.4814195641238932, 0.4823567500527451, 0.4833105909780232, 0.48428130095560956, 0.4852691003403973, 0.4862742160409682, 0.4872968817876381, 0.48833733841473886, 0.4893958341580728, 0.49047262496855204, 0.4915679748431102, 0.26144639482460363, 0.272374581924283, 0.2833784111737099, 0.29446221065379163, 0.30563061434026273, 0.3168885937717084, 0.32824149412508213, 0.33969507546795097, 0.3512555601208269, 0.36292968726880936, 0.3747247762219094, 0.3866488000546075, 0.39871047178022617, 0.4109193457659802, 0.42328593781355467, 0.4358218682789667, 0.4485400338713297, 0.46145481547854494, 0.4745823317029553, 0.4879407510254602, 0.5015506800676857, 0.4937587474410283, 0.4860304404359788, 0.47836400601078927, 0.4707578015788686, 0.46321028687210797, 0.45572001657910916, 0.4482856336697358, 0.44090586332913906, 0.43357950743437257, 0.4263054395152207, 0.4190826001481395, 0.41190999273846846, 0.404786679651449, 0.39771177865725105, 0.3906844596592266, 0.38370394167812083, 0.3767694900680166, 0.3698804139424595, 0.36303606379152886, 0.3562358292726813, 0.36675061016011296, 0.37746326828173404, 0.3883889102597998, 0.3995445243052686, 0.41094932857249644, 0.4226252069547788, 0.4345972607415786, 0.446894516165342, 0.45955084531194884, 0.47260618472475496, 0.4861081784996414, 0.5001144419061254, 0.5146957584780583, 0.5299407291044733, 0.5459627708562798, 0.5629111037220667, 0.5809889129604298, 0.6004854103660356, 0.6218375365311664, 0.645763795021781, 0.6214666624554028, 0.5993506218786019, 0.5788433062446563, 0.5595847476530221, 0.5413310585567284, 0.5239079152655273, 0.5071855767236353, 0.4910643773276805, 0.47546577910277926, 0.4603265816994898, 0.4455950262269472, 0.4312280866473167, 0.4171895341373746, 0.4034485207528595, 0.3899785216160257, 0.37675653056533853, 0.36376243876464864, 0.35097854783873605, 0.33838918356416214};
real32 theta1[] =
    { 1.1545592545599679, 1.1586151627848158, 1.1626546236129587, 1.16667778922829, 1.1706848089441526, 1.1746758292727468, 1.1786509939923526, 1.1826104442124585, 1.1865543184368743, 1.1904827526248951, 1.1943958802506045, 1.1982938323603702, 1.2021767376286097, 1.2060447224118822, 1.2098979108013732, 1.213736424673824, 1.217560383740968, 1.2213699055975193, 1.2251651057677737, 1.2289460977508622, 1.2333114510363261, 1.237654960788431, 1.241976807735864, 1.2462771687296097, 1.2505562168402267, 1.254814121451914, 1.259051048353505, 1.2632671598265093, 1.2674626147303139, 1.2716375685846653, 1.275792173649528, 1.2799265790024286, 1.2840409306133789, 1.288135371417471, 1.292210041385232, 1.2962650775908247, 1.3003006142781734, 1.3043167829250937, 1.3083137123054949, 1.3122915285497372, 1.3083938816785041, 1.3044822823342095, 1.3005566261777846, 1.2966168070274762, 1.292662716819868, 1.2886942455697878, 1.2847112813290629, 1.2807137101440804, 1.2767014160121155, 1.2726742808363773, 1.268632184379731, 1.2645750042170487, 1.2605026156861343, 1.2564148918371782, 1.2523117033806788, 1.2481929186337823, 1.244058403464976, 1.239908021237077, 1.23574163274845, 1.1504867438123008, 1.1403320297973965, 1.1300720984423436, 1.1197043432557778, 1.1092260257500002, 1.0986342665262019, 1.0879260355595117, 1.077098141594452, 1.0661472205493152, 1.0550697228140202, 1.043861899309747, 1.0325197861597535, 1.0210391877985856, 1.0094156583209535, 0.9976444808409102, 0.9857206445958033, 0.973638819486553, 0.9613933276946729, 0.9489781119552733, 0.9363866999917906, 1.147469843060702, 1.1346080301349595, 1.1215684011754854, 1.108345387698247, 1.0949330512087827, 1.0813250504495449, 1.067514604769334, 1.0534944530390942, 1.0392568074345379, 1.0247933012800399, 1.0100949299944526, 0.9951519839907944, 0.9799539721488961, 0.9644895341909436, 0.9487463399285224, 0.932710972895101, 0.9163687953015901, 0.8997037905164182, 0.8826983783233167, 0.8653331969775577, 1.1911398761144567, 1.1876487209866389, 1.184143639732499, 1.180624529746486, 1.1770912866142076, 1.1735438040728947, 1.1699819739707276, 1.1664056862249803, 1.1628148287789355, 1.159209287557534, 1.155588946421709, 1.1519536871213567, 1.1483033892468915, 1.1446379301793383, 1.1409571850389053, 1.1372610266319783, 1.133549325396478, 1.12982194934552, 1.1260787640093108, 1.1223196323752125, 0.8793899623530901, 0.8751985855333912, 0.870981701581784, 0.8667389631261262, 0.8624700135847774, 0.8581744868306864, 0.8538520068395096, 0.8495021873208187, 0.8451246313314035, 0.8407189308695817, 0.8362846664493744, 0.8318214066533057, 0.8273287076624967, 0.8228061127626392, 0.8182531518243041, 0.813669340755946, 0.809054180927821, 0.8044071585649122, 0.7997277441067919, 0.795015391532196, 1.090628057357337, 1.0766177641346193, 1.0623839235095307, 1.0479183210698308, 1.033212116518216, 1.0182557788134947, 1.0030390123201758, 0.987550672395089, 0.9717786685044428, 0.9557098525442029, 0.9393298895052985, 0.9226231069486934, 0.9055723188871281, 0.8881586185463086, 0.8703611330095875, 0.852156730811813, 0.8335196709621219, 0.8144211783854868, 0.7948289260027778, 0.7747063970594429, 0.7540120920155154, 0.7612962801153582, 0.768425430325911, 0.7754033188501646, 0.782233501155869, 0.7889193285993954, 0.7954639634649477, 0.8018703926000238, 0.8081414398040803, 0.8142797771069885, 0.8202879350564971, 0.8261683121190492, 0.8319231832855212, 0.8375547079624658, 0.8430649372199149, 0.848455820458584, 0.8537292115521609, 0.8588868745141286, 0.8639304887331334, 0.8688616538161524, 0.8736818940745331, 0.8544186889512237, 0.8347333574873329, 0.8145953014009293, 0.7939700759414035, 0.7728186784603303, 0.7510966583635007, 0.7287529903842392, 0.705728629405256, 0.6819546294138372, 0.6573496543079602, 0.6318166215077715, 0.6052380778690656, 0.5774696685392904, 0.5483306393553999, 0.5175895386067836, 0.4849417711349091, 0.4499724917115073, 0.4120911005700596, 0.3704051761399066, 0.32344702409386566, 0.36583966894393, 0.4037246834757708, 0.43827097830300754, 0.4702135034543304, 0.5000500482781196, 0.5281362824318399, 0.5547367955823131, 0.5800547367383879, 0.6042500950118646, 0.6274515286116338, 0.6497643245980039, 0.6712759324108802, 0.6920599182306997, 0.7121788584272254, 0.7316865005761002, 0.7506294066845985, 0.7690482226626324, 0.7869786729858704, 0.8044523499515024};

#define NUM_LINKS 2
real32 L[] = { 100.0f, 50.0f };
real32 u[] = { 0.0f, 0.0f };

real32 x_target = 100.0f;
real32 y_target = 0.0f;

#define TRACE_MAX_NUM_POINTS 100024
Queue<vec2> trace;

uint32 mode;

int main() {
    Camera2D camera_2D = { 256.0f };
    bool ik = false;
    while (cow_begin_frame()) {
        mat4 PV = camera_get_PV(&camera_2D);
        camera_move(&camera_2D);


        gui_slider("L_0", &L[0], 0.0f, 100.0f);
        gui_slider("L_1", &L[1], 0.0f, 100.0f);
        gui_slider("theta_0", &u[0], -PI, PI, true);
        gui_slider("theta_1", &u[1], -PI, PI, true);
        gui_checkbox("ik", &ik, 'i');

        if ((globals._input_owner == COW_INPUT_OWNER_NONE) && globals.mouse_left_held) {
            vec2 mouse_s = mouse_get_position(PV);
            x_target = mouse_s.x;
            y_target = mouse_s.y;
        }

        static int index;
        u[0] = theta0[index];
        u[1] = theta1[index];
        index = MIN(index + 1, ARRAY_LENGTH(theta0) - 1);

        // FK
        real32 x_0 = 0.0f;
        real32 y_0 = 0.0f;
        real32 x_1 = x_0 + L[0] * COS(u[0]);
        real32 y_1 = y_0 + L[0] * SIN(u[0]);
        real32 x_2 = x_1 + L[1] * COS(u[0] + u[1]);
        real32 y_2 = y_1 + L[1] * SIN(u[0] + u[1]);

        queue_enqueue(&trace, { x_2, y_2 });
        if (trace.length > TRACE_MAX_NUM_POINTS) queue_dequeue(&trace);

        eso_begin(PV, SOUP_LINES);
        eso_color(monokai.white);
        for (uint32 i = 0; i < trace.length; ++i) {
            eso_vertex(trace.array[i]);
        }
        eso_end();

        eso_begin(PV, SOUP_LINES, 12.0f);
        eso_color(color_kelly(0));
        eso_vertex(x_0, y_0);
        eso_vertex(x_1, y_1);
        eso_color(color_kelly(1));
        eso_vertex(x_1, y_1);
        eso_vertex(x_2, y_2);
        eso_end();

        eso_begin(PV, SOUP_POINTS, 12.0f);
        eso_color(monokai.green);
        eso_vertex(x_target, y_target);
        eso_end();
    }
}
